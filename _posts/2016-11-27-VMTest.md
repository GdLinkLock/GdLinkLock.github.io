---
layout: page
title: "VMTest"
comments: true
tags: [tool vmmap]
categories: Tools
header:
   image_fullwidth: "header_unsplash_library.jpg"
---
> 如果这个事情来了 你没有勇敢的解决掉 他一定会再来

# vmmap

大概三年前见到同事在做内存profile时使用了VMMap，第一印象是这个工具五颜六色看起来很炫。之后自己也用过几次，每次都要先查一下VMMap上各个数字的含义是什么；甚为困惑。   

今天，我们就再来认识一下VMmap；并通过一个辅助工具来查看VMMap变化。我想以后在使用VMmap之前不必先查资料了。

## vmmap 窗口

![vmmap](/images/2016/20161127-vmmap-ui.jpg)

### Summary

* **committed**：表示进程可用内存，而不是所有内存；另一部分是Reserved内存。会被ram、paging file、mapping file backup

* **private bytes**：进程独享内存,会被ram、paging file backup

* **working set**：驻留在physical ram的虚拟内存

### Memory Types

* **Image**：The memory represents an executable file, such as an ***EXE or DLL***, that has been **loaded into a process by the image loader**. Note that Image memory does not include executable files loaded as data files—these are included in the Mapped File memory type. Executable code regions are typically read/execute-only and shareable. Data regions, such as initialized data, are typically read/write or copy-on-write. When 
copy-on-write pages are modified, additional private memory is created in the process and is marked as read/write. This private memory is backed by RAM or a paging file and not by the image file. The Details column in Details View shows the file’s path or section name.

* **Mapped File**：The memory is shareable and ***represents a file on disk***. Mapped files are often resource DLLs and typically contain application data. The Details column shows the file's path.

* **Shareable**：***Shareable memory is memory*** that can be shared with other processes and is backed by RAM or by the paging file (if present). Shareable memory typically contains data shared between processes through DLL shared sections or through pagefile-backed, file-mapping objects (also known as pagefile-backed sections)

* **Heap**：A heap represents private memory ***allocated and managed by the user-mode heap manager*** and typically contains application data. Application memory allocations that use Heap memory include the C runtime malloc library, the C++ newoperator, the Windows Heap APIs, and the legacy GlobalAllocand LocalAlloc APIs.

* **Managed Heap**：Managed Heap represents private memory that is ***allocated and managed by the .NET runtime*** and typically contains application data

* **Stack**：Stack memory is allocated to each thread in a process to store function parameters, local variables, and invocation records.

* **Page Table**：Page Table memory is ***private kernel-mode memory*** associated with the process’ page tables. Note that Page Table memory is never displayed in VMMap’s Details View, which shows only user-mode memory.

* **Private Data**：Private Data memory is memory that is ***allocated by VirtualAlloc*** and that is not further handled by the Heap Manager or the .NET runtime, or assigned to the Stack category. Private Data memory typically contains application data, as well as the Process and Thread Environment Blocks. Private Data memory cannot be shared with other processes.

* **Free**：Free memory regions are spaces in the process’ ***virtual address space that are not allocated***.



### Memory Information

* **Size**：he total size of the allocated type or region. This includes areas that have been reserved but not committed

* **Committed**：The amount of the allocation that is committed—that is, backed by RAM, a paging file, or a mapped file

* **Private**：The amount of the allocation that is private to the process

* **Total WS**：The total amount of working set (physical memory) assigned to the type or region.

* **Private WS**：The amount of working set assigned to the type or region that cannot be shared with other processes

* **Shareable WS**： The amount of working set assigned to the type or region that can be shared with other processes.

* **Shared WS**：The amount of Shareable WS that is currently shared with other processes

* **Locked WS**：The amount of memory that has been guaranteed to remain in physical memory and not incur a page fault when accessed

* **Blocks**：The number of individually allocated memory regions

* **Largest**：In Summary View, the size of the largest contiguous memory block for that allocation type.

## VMTest 

build with vs2015，dependency dx9

只是为了演示VMMap字段变化，程序没有做异常处理。顺序点击每个按钮即可。

[DownLoad](/images/2016/20161127-vmtest-bin.7z)

![辅助工具VMTest](/images/2016/20161127-VMTest-ui.jpg)

从上到下，依次可观察到的变化是：Image、Mapped File、 Shareable、Heap、Private data

*备注：无论是memory type还是memory information；表示的概念都不是正交的。比如：当调用LoadLibrary时，Image会增加，Private data也可能增加。*